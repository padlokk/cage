# Cage Development Tasks

**Updated:** 2025-09-28
**Current Version:** 0.5.0
**Roadmap Reference:** docs/procs/ROADMAP.md (Stakeholder MVP Alignment)

## Story Point Scale
- 1 pt = 1-2 hours (simple fix/addition)
- 3 pts = 4-6 hours (moderate implementation)
- 5 pts = 1-2 days (complex feature)
- 8 pts = 3-5 days (major system component)

Status legend: ✅ complete · 🟡 partial/in progress · 🔴 not started · ⏸ deferred

---

## Phase 1 – API Foundations & Parity

### CAGE-11: Operation Request API [5 pts] ✅
**Scope:** Typed request structs (Lock/Unlock/Rotate) plus `CageConfig` unifying CLI and library entry points.
**Status:** Landed. CLI, library, and docs use the shared builders; identity/recipient data flows end-to-end.

### CAGE-06: Config Helper & Discovery [5 pts] 🟡
**Status:** `AgeConfig` loads layered TOML (env → XDG → local) and exposes backup/streaming defaults. A CLI/library helper for viewing/editing `cage.toml` is still missing.
**Next:**
- [ ] Provide read/inspect helper (CLI subcommand or `cage config --show`).
- [ ] Add `--edit`/`--open` flow or documented integration with `$EDITOR`.
- [ ] Document config discovery order in README/QUICK_REF.

### CAGE-12: Adapter V2 Refresh [5 pts] 🟡
**Status:** V2 trait, compatibility wrapper, and ShellAdapterV2 implemented. Streaming works for passphrase + recipient flows; capability metadata exists. Remaining gaps:
- [ ] Ensure `health_check`/factory expose accurate streaming + identity support flags.
- [ ] Implement identity-based streaming encrypt (currently passphrase-only) or mark limitation explicitly.
- [ ] Harden error surfaces (stderr parsing, partial write-reporting).

### QA-01: Documentation & Library Sync [3 pts] 🟡
**Status:** `docs/LIBRARY_USAGE.md` updated for requests and streaming basics. Needs more parity examples.
- [ ] Add recipient/identity/streaming samples mirroring CLI flags.
- [ ] Document config helper once implemented (CAGE-06).
- [ ] Capture known limitations (SSH identities pending, streaming perf TBD).

---

## Phase 2 – Advanced Encryption Capabilities

### CAGE-12a: Streaming Benchmark & Hardening [5 pts] 🟡
**Status:** Pipe-based streaming landed with round-trip test. Large-file validation and capability notes outstanding.
- [ ] Benchmark 1–5 GB streams (passphrase + recipients) and record throughput/memory.
- [ ] Add regression/bench harness (can live under `tests/` gated by env flag).
- [ ] Surface capability hints in CLI (`cage --inspect adapter`).

### CAGE-14: SSH Identity Support [5 pts] 🔴
- [ ] Accept `--ssh-identity` / config entries (file paths or inline material).
- [ ] Convert SSH keys via `age::ssh` or CLI helper and feed adapters.
- [ ] Regression tests with generated SSH keypairs.
- [ ] Documentation + security callouts.

### CAGE-15: Deterministic Key Derivation [5 pts] 🔴
- [ ] Extend config/request structs with derive parameters (salt/context).
- [ ] Invoke age binary with `--derive` and capture outputs.
- [ ] Add tests verifying deterministic behaviour + error paths.
- [ ] Document usage guidance and salting requirements.

### CAGE-16: Multi-Recipient Lifecycle [8 pts] 🔴
- [ ] Formalize recipient group model (struct/enums) for request API + config.
- [ ] Update adapters/CrudManager to accept recipient vectors for all encrypt ops.
- [ ] Provide lifecycle helpers (list/add/remove recipients, audit metadata).
- [ ] Tests ensuring each recipient can decrypt; include rotation scenarios.

### CAGE-13: Streaming CLI Options [5 pts] 🔴
- [ ] Expose streaming flags/config toggles (e.g., `--streaming-strategy`, already parsed) with doc coverage.
- [ ] Wire strategy selection into requests + capability reporting.
- [ ] Extend CLI help/README with streaming workflow guidance.

---

## Phase 3 – Hardening & Tooling

### SEC-01: Centralized String Management [5 pts] 🟡
**Status:** `src/cage/strings.rs` exists and houses many reusable constants, but glyph/emoji output intentionally retained for UX. Remaining work focuses on linting + guidance.
- [x] Create shared string module.
- [ ] Audit remaining inline literals in critical modules.
- [ ] Provide lint/check (e.g., deny `todo!` or custom script) to flag new inline strings.
- [ ] Document expectations in CONTRIBUTING/PROCESS.
- [ ] Evaluate optional “ASCII-safe” mode without forcing removal of branded glyphs.

### CAGE-03: Backup Retention Lifecycle [5 pts] 🟡
**Reference:** `docs/ref/cage/BACKUP_RETENTION_DESIGN.md`
**Status:** RetentionPolicy enum + basic enforcement wired into `BackupManager`; registry, conflict strategy, and CLI ergonomics remain.
- [x] Add retention enum + enforcement hooks in `BackupManager`.
- [x] Support configurable backup directories and cleanup defaults via `AgeConfig`.
- [ ] Implement JSON-backed `BackupRegistry` with generation tracking.
- [ ] Apply retention when creating backups; archive/delete expired entries safely.
- [ ] Add backup discovery helpers (list/restore generations) for future CLI use.
- [ ] Write integration tests covering retention + migration from legacy `.bak` files.

### OBS-01: Structured Audit & Telemetry [3 pts] 🔴
- [ ] Capture streaming/identity/recipient events with structured metadata.
- [ ] Ensure sensitive fields are redacted before logging.
- [ ] Offer JSON/structured output toggle for downstream systems.
- [ ] Update docs with telemetry configuration.

### QA-02: End-to-End Test Coverage [3 pts] 🔴
(Retires legacy TEST-01/02/03/04 entries; replans under single umbrella.)
- [ ] Restore CLI smoke suite targeting the installed `cage` binary.
- [ ] Expand regression coverage for BUG-01..05 behaviours (extensions, recursion, globs, unlock options).
- [ ] Add proxy PTY scenarios with skip gating when `age`/PTY missing.
- [ ] Confirm age-dependent tests skip gracefully (selective unlock already uses `which::which`).

### DOC-03: Library Usage Accuracy [1 pt] 🟡
- [x] Mention request API and streaming basics.
- [ ] Clearly mark SSH/derive/multi-recipient as roadmap items until implemented.
- [ ] Add configuration helper usage once CAGE-06 ships.

---

## Module Spec Alignment (MOD3 Series)

### MOD3-01: Establish Project Prelude [2 pts] 🔴
**Reference:** `docs/ref/rsb/MODULE_SPEC.md`
- [ ] Create `src/prelude.rs` that curates the public Surface (CrudManager, requests, adapter traits, macros).
- [ ] Update `lib.rs` to re-export via `pub mod prelude` and document usage in README.
- [ ] Add sanity tests ensuring prelude compilations stay minimal.

### MOD3-02: Dependency Re-export Surface [2 pts] 🔴
- [ ] Introduce `src/deps.rs` (standard RSB pattern) re-exporting external crates we expect downstream users to consume (`age`, `rsb`, `hub`).
- [ ] Audit modules to pull shared imports via `crate::deps` where appropriate.
- [ ] Note intentionally excluded crates (e.g., heavy optional deps) in the module doc comment.

### MOD3-03: Relocate Driver Example [1 pt] 🔴
- [ ] Move `src/driver.rs` demo into either `src/bin` or `examples/` to satisfy the “no stray top-level modules” rule in the module spec.
- [ ] Update docs referencing the driver (if any) to the new path.
- [ ] Ensure integration tests or demos still compile after relocation.

---

## Completed / Archived (for reference)
- BUG-01..05 – Critical CLI regressions resolved mid-2025.
- CAGE-11a – Identity/recipient request parity.
- INFRA-01 – RSB terminal-ext integration.
- TEST-04 – Age availability gating incorporated into selective unlock tests.
