# Cage Development Tasks

**Updated:** 2025-09-27
**Current Version:** 0.3.1
**Status:** Planning Refresh (CAGE/BUG/TEST series)

## Story Point Scale
- 1 pt = 1-2 hours (simple fix/addition)
- 3 pts = 4-6 hours (moderate implementation)
- 5 pts = 1-2 days (complex feature)
- 8 pts = 3-5 days (major system component)

---

## Critical Bugs (Blocking Production)

### BUG-01: Preserve Original Extensions During Lock/Unlock [3 pts] âœ…
**Status:** Complete â€“ `lock_single_file` now appends the configured suffix and `unlock_single_file` only strips that suffix (`src/cage/lifecycle/crud_manager.rs:856`, `src/cage/lifecycle/crud_manager.rs:939`). Regression coverage still recommended.

### BUG-02: Recursive Operations Ignore Subdirectories [5 pts] âœ…
**Status:** Complete â€“ Depth-first traversal with glob support is live (`src/cage/lifecycle/crud_manager.rs:1212`).

### BUG-03: Pattern Filters Treat Globs as Literal Substrings [3 pts] âœ…
**Status:** Complete â€“ `globset` matcher is used for lock/unlock/status/verify (`src/cage/lifecycle/crud_manager.rs:1203`).

### BUG-04: Unlock Options Ignored [3 pts] ðŸŸ¡
**Status:** Implementation merged (selective unlock + regression suite), but follow-ups remain before closing out.
**Next Actions:**
- [ ] Replace non-ASCII log output in selective mode with ASCII-only messaging (`src/cage/lifecycle/crud_manager.rs:989`).
- [ ] Ensure selective unlock tests skip gracefully when the `age` binary is unavailable.

### BUG-05: Proxy Command Still Uses Expect Script [5 pts] âœ…
**Status:** Complete â€“ Proxy command now routes through `PtyAgeAutomator` (`src/bin/cli_age.rs:993`). Follow-up tests still pending (see TEST-03).

---

## Core Feature Work (CAGE Series)

### CAGE-01: Implement Key Rotation Lifecycle [8 pts]
**Source:** Former TASK-001 (`src/cage/lifecycle/crud_manager.rs:196-400`).
**Deliverables:** Atomic oldâ†’new passphrase rotation with backup/rollback, permission preservation, and coverage.

### CAGE-02: File Integrity Verification System [5 pts]
**Source:** Former TASK-002 (`src/cage/lifecycle/crud_manager.rs:1000-1106`).
**Deliverables:** Header/format validation, optional decrypt probe, structured reporting, and corruption handling.

### CAGE-03: Backup & Recovery Pipeline [5 pts] ðŸŸ¡
**Status:** Partial â€“ `backup_before_lock` covers single-file backups with restore-on-failure (`src/cage/lifecycle/crud_manager.rs:864`), but retention policies, user-configurable dirs, and multi-run conflict handling remain.

### CAGE-04: In-Place Operation Safety Layers [5 pts]
**Location:** `src/bin/cli_age.rs:569-760`, `src/cage/in_place.rs`.
**Scope:** Finish SafetyValidator/RecoveryManager wiring, ensure metadata preservation, document danger mode, and test rollback.

### CAGE-05: Progress & Telemetry Surface [3 pts]
**Location:** Progress manager utilities.
**Scope:** Integrate spinner/bar styles with CRUD operations, respect verbosity flags, and expose hooks for long jobs.

### CAGE-06: Configuration File Support [5 pts]
**Status:** Pending â€“ `AgeConfig` only offers programmatic defaults; no on-disk config loader or CLI wiring exists.

### CAGE-07: RageAdapter Implementation [8 pts]
**Status:** Deferred backlog â€“ Rage adapter remains a stub returning `AdapterNotImplemented` (`src/cage/adapter.rs:128`).

[5] CAGE-08: Multi-Recipient Encryption Support [Backlog]
**Location:** Adapter + CRUD pipeline + CLI
**Scope:** Allow callers (e.g., Ignite) to supply multiple `age` recipients so parents retain access to child-encrypted artifacts.
**Tasks:**
- [ ] Extend `AgeAdapter` / `CrudManager` to accept `Vec<Recipient>` and invoke `age` in public-key mode.
- [ ] Update proxy command to forward recipient sets rather than single passphrase.
- [ ] Extend CLI/config to accept recipient lists.
- [ ] Add tests ensuring each recipient can decrypt (parent + child scenario).

[4] CAGE-09: SSH Recipient Integration [Backlog]
**Location:** Adapter + CLI
**Scope:** Support SSH-derived age recipients alongside native `.age` keys so Ignite and future clients can mix credential types.
**Tasks:**
- [ ] Provide conversion from SSH public keys to age recipients.
- [ ] Document CLI usage / config knobs.
- [ ] Tests covering encrypt/decrypt with SSH recipients.

[4] CAGE-10: Identity Key Support (Backlog)
**Location:** Adapter + CRUD pipeline + CLI
**Scope:** Provide first-class identity/key-file flows (Age `--identity`) so unlock/no-passphrase operations work without proxy handoffs.
**Tasks:**
- [ ] Extend CRUD interfaces to accept identity files for decrypt/verify.
- [ ] Update `PtyAgeAutomator` to invoke `age -d -i` when identities supplied.
- [ ] Surface CLI flags and config for identity management.
- [ ] Add regression tests covering identity-driven unlock.

---

## Test & Tooling Improvements (TEST Series)

### TEST-01: Align CLI Suites with Current Binary [3 pts]
**Status:** Pending â€“ scripts still invoke removed binaries.

### TEST-02: Regression Coverage for BUG-01..04 [3 pts]
**Scope:** Add targeted unit/integration tests to lock in newly fixed behaviours (extensions, recursion, globbing, unlock options).

### TEST-03: Proxy PTY Integration Tests [2 pts]
**Status:** Pending â€“ implement after stabilising proxy command.

### TEST-04: Gate Age-Dependent Unlock Tests [1 pt]
**Scope:** Keep BUG-04 regression suite while avoiding hard failures when `age` is missing.
**Tasks:**
- [ ] Detect `age` availability in `tests/test_selective_unlock.rs` and skip gracefully when absent.
- [ ] Document the dependency in TESTING notes / README.
- [ ] Ensure CI environments without `age` remain green.

---

## Future Infrastructure (INFRA Series)

### INFRA-01: Migrate to RSB dev-pty Module [COMPLETE via Hub] âœ…
**Background**: RSB 0.6.2 includes `dev-pty` feature with `rsb::dev::pty` module, but API exports don't match `portable-pty` interface.
**Solution**: Migrated to Hub's `terminal-ext` feature which provides `portable-pty` via RSB ecosystem.
**Benefits**: âœ… Achieved - Reduced dependency count, better RSB ecosystem integration via Hub.
**Status**: Completed using `hub = { git = "https://github.com/oodx/hub.git", features = ["terminal-ext"] }`.

### INFRA-02: Migrate to RSB Progress Module [3 pts]
**Location**: `src/cage/progress/*` â†’ `rsb::progress`
**Issue**: Cage maintains local copy of progress module (`cage::cage::progress`) that duplicates RSB's version.
**Tasks**:
- [ ] Replace `use cage::cage::progress` with `use rsb::progress` throughout codebase
- [ ] Remove `src/cage/progress/` directory (5 files: core, manager, mod, styles, terminal)
- [ ] Verify CAGE-05 progress integration still functions correctly
- [ ] Update documentation references from `cage::progress` to `rsb::progress`
**Benefits**: Reduced code duplication, leverage RSB ecosystem updates, cleaner dependency graph.

---

## Notes
- Keep CHANGELOG entries aligned with CAGE/BUG/TEST identifiers.
- Prioritise BUG-01..05 before starting new CAGE work; they unblock documented scenarios.
- Coordinate config and backup changes with documentation updates in README and `docs/tech/*`.

[4] CAGE-10: Identity Key Support (Backlog)
**Location:** Adapter + CRUD pipeline + CLI
**Scope:** Provide first-class identity/key-file flows (Age `--identity`) so unlock/no-passphrase operations work without proxy handoffs.
**Tasks:**
- [ ] Extend CRUD interfaces to accept identity files for decrypt/verify.
- [ ] Update `PtyAgeAutomator` to invoke `age -d -i` when identities supplied.
- [ ] Surface CLI flags and config for identity management.
- [ ] Add regression tests covering identity-driven unlock.
