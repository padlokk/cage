# Cage Adapter Module (Age Backend Abstraction)

Updated: 2025-10-01

## Purpose
- Provide a flexible, extensible abstraction for age encryption backends
- Decouple encryption operations from specific implementation details
- Support multiple backend strategies with a consistent interface
- Enable seamless migration between different age encryption methods

## Feature Flags
- `adp` — Adapter pattern module for age encryption
  - Enables flexible backend selection and abstraction
  - Default: Enabled

## Imports
```rust
use cage::adp::{
    AgeAdapter,
    AdapterFactory,
    StreamingStrategy,
    AgeAdapterV2,
    ShellAdapterV2,
    AdapterV1Compat
};
```

## Core API
### Types
- `AgeAdapter` — Core trait defining encryption/decryption operations
- `AdapterFactory` — Factory for creating different age backend adapters
- `StreamingStrategy` — Enum defining passphrase and file streaming approaches
- `ShellAdapter` — PTY-based shell adapter for age CLI operations
- `RageAdapter` — Placeholder for future rage library direct integration

### Traits & Interfaces
- `AgeAdapter`
  - `encrypt(input, output, passphrase, format)` — Encrypt file with given parameters
  - `decrypt(input, output, passphrase)` — Decrypt file with given passphrase
  - `health_check()` — Validate adapter functionality
  - `adapter_name()` — Get unique adapter identifier
  - `adapter_version()` — Retrieve adapter version information

## Patterns
- Factory pattern for adapter creation
- Versioned adapter implementations (v1 and v2)
- Streaming strategy selection
- PTY automation for secure passphrase handling

## Examples
```rust
// Basic adapter usage
fn example_usage() -> AgeResult<()> {
    // Create default adapter
    let adapter = AdapterFactory::create_default()?;

    // Encrypt a file
    adapter.encrypt(
        Path::new("input.txt"),
        Path::new("encrypted.age"),
        "secure_passphrase",
        OutputFormat::default()
    )?;

    // Decrypt the file
    adapter.decrypt(
        Path::new("encrypted.age"),
        Path::new("decrypted.txt"),
        "secure_passphrase"
    )?;
}

// Advanced: Selecting specific adapter and streaming strategy
fn advanced_example() -> AgeResult<()> {
    let v2_adapter = AdapterFactory::create_adapter("shell")?;
    v2_adapter.configure_streaming(StreamingStrategy::Auto);
}
```

## Integration
- Tightly integrated with Cage's PTY automation module
- Supports future library backend migration
- Dependency: Age CLI binary for shell-based operations
- Future expansion planned for direct library integration

## Testing
- Unit tests located in `tests/adp/`
- Comprehensive adapter creation and operation tests
- Mocking support for different backend simulations
- Coverage expectations: >90%
- Special considerations for PTY and passphrase handling

## Performance Characteristics
- Minimal overhead for adapter abstraction
- Streaming strategies optimize memory usage
- Configurable streaming approaches (Auto, TempFile, Pipe)
- Low latency for small to medium-sized files
- Constant memory footprint with streaming optimizations

## Limitations
- Requires Age CLI for current implementation
- Potential performance impact with complex streaming
- RageAdapter not yet fully implemented
- PTY-based approach has some system-specific constraints

## Status
- MODERN: Yes
  - Modular design with clear separation of concerns
  - Support for multiple backend strategies
  - Extensible architecture
- SPEC_ALIGNED: Yes
  - Follows age encryption specification
  - Provides consistent interface across different backends

## Changelog
- 2025-10-01: Initial documentation of adapter module
  - Documented v1 and v2 adapter implementations
  - Added streaming strategy details
  - Highlighted future expansion plans

## References
- Age Encryption Specification
- Cage PTY Automation Documentation
- Rust Age Encryption Libraries

---

_Generated by Cage Feature Documentation Generator_

<!-- feat:adp -->

_Generated by bin/feat2.py --update-doc._

* `src/adp/mod.rs`
  - pub use v1::{AgeAdapter, AdapterFactory} (line 29)
  - pub use v2::{AgeAdapterV2, ShellAdapterV2, AdapterV1Compat, StreamingStrategy} (line 30)

* `src/adp/pipe.rs`
  - trait PassphrasePipeStreaming (line 70)

* `src/adp/v1.rs`
  - trait AgeAdapter (line 15)
  - struct ShellAdapter (line 42)
  - fn new (line 49)
  - fn validate_dependencies (line 60)
  - fn available_methods (line 65)
  - struct RageAdapter (line 145)
  - fn new (line 153)
  - struct AdapterFactory (line 199)
  - fn create_default (line 203)
  - fn create_adapter (line 209)
  - fn available_adapters (line 224)
  - fn recommended_adapter (line 229)

* `src/adp/v2.rs`
  - enum StreamingStrategy (line 21)
  - trait AgeAdapterV2 (line 45)
  - struct VerificationResult (line 144)
  - enum DetectedFormat (line 163)
  - struct FileMetadata (line 174)
  - struct HealthStatus (line 190)
  - struct AdapterCapabilities (line 215)
  - struct StreamingStrategyInfo (line 249)
  - enum StreamingStrategyKind (line 277)
  - struct AdapterV1Compat (line 288)
  - fn new (line 294)
  - struct ShellAdapterV2 (line 348)
  - fn new (line 369)
  - fn with_config (line 375)
  - struct StreamBuffer (line 1279)
  - fn new (line 1329)
  - fn default (line 1338)
  - fn as_mut_slice (line 1343)
  - fn filled (line 1348)
  - fn advance (line 1353)
  - fn reset (line 1358)

<!-- /feat:adp -->

